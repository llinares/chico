/**
  * Chico-UI
  * Packer-o-matic
  * Like the pizza delivery service: "Les than 100 milisecons delivery guarantee!"
  * @components: core, position, positioner, object, floats, navs, modal
  * @version 0.3
  * @autor Natan Santolo <natan.santolo@mercadolibre.com>
  *
  * based on:
  * @package JSMin
  * @package CssMin
  * @license http://opensource.org/licenses/mit-license.php MIT License
  */
;(function($){

var ui=window.ui={version:"0.4.6",components:"modal",internals:"position,positioner,object,floats,navs",instances:{},init:function(){$("html").removeClass("no-js");ui.components=(window.components)?ui.components+","+window.components:ui.components;ui.internals=(window.internals)?ui.internals+","+window.internals:ui.internals;$(ui.components.split(",")).each(function(i,e){ui.factory({component:e});});},utils:{body:$('body'),html:$('html'),window:$(window),document:$(document),zIndex:1000}}
ui.factory=function(o){if(!o){alert("Factory fatal error: Need and object {component:\"\"} to configure a component.");return;};if(!o.component){alert("Factory fatal error: No component defined.");return;};var x=o.component;if(!ui.instances[x]){ui.instances[x]=[];}
var create=function(x){$.fn[x]=function(options){var results=[];var that=this;var options=options||{};if(typeof options!=="object"){alert("Factory "+x+" configure error: Need a basic configuration.");return;};that.each(function(i,e){var conf={};conf.name=x;conf.element=e;conf.id=i;$.extend(conf,options);var created=ui[x](conf);results.push(created);ui.instances[x].push(created);});return(results.length>1)?results:results[0];}
if(o.callback){o.callback();}}
if(ui[o.component]){create(o.component);}else{ui.get({"method":"component","component":o.component,"script":(o.script)?o.script:"src/js/"+o.component+".js","styles":(o.style)?o.style:"src/css/"+x+".css","callback":create});}}
ui.get=function(o){switch(o.method){case"content":var result;var x=o.conf;x.$htmlContent.html('<div class="loading"></div>');$.ajax({url:x.content.data,type:x.ajaxType||'POST',data:x.ajaxParams||'x=x',cache:true,async:false,success:function(data){result=data;},error:function(data){result=false;}});return result;break;case"component":if(o.style){var style=document.createElement('link');style.href=o.style;style.rel='stylesheet';style.type='text/css';}
if(o.script){var script=document.createElement("script");script.src=o.script;}
var head=document.getElementsByTagName("head")[0]||document.documentElement;var done=false;script.onload=script.onreadystatechange=function(){if(!done&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){done=true;if(o.callback){o.callback(o.component);}
script.onload=script.onreadystatechange=null;if(head&&script.parentNode){head.removeChild(script);}}};if(o.script){head.insertBefore(script,head.firstChild);}
if(o.style){head.appendChild(style);}
break;}}
ui.position={center:function(conf){var align=function(){conf.$htmlContent.css({left:(parseInt(ui.utils.window.width())-conf.$htmlContent.outerWidth())/2,top:(ui.utils.html.hasClass('ie6'))?'':(parseInt(ui.utils.window.height())-conf.$htmlContent.outerHeight())/2});};align();ui.utils.window.bind('resize',align);},down:function(conf){var align=function(){conf.$htmlContent.css({top:conf.$wrapper.outerHeight()+10,left:(conf.$wrapper.outerWidth()/2)-20});};align();ui.utils.window.bind('resize',align);},right:function(conf){var align=function(){conf.$htmlContent.css({top:(conf.$wrapper.height()/2)-11,left:conf.$wrapper.outerWidth()+13});};align();ui.utils.window.bind('resize',align);},follow:function(conf){conf.$trigger.bind('mousemove',function(event){conf.$htmlContent.css({top:event.pageY+20,left:event.pageX-32});});}}
ui.positioner=function(o){var element=$(o.element);var context;if(!o.points)o.points="cm cm";if(!o.offset)o.offset="0 0";var classReferences={"lt lb":"down","lb lt":"top","rt rb":"down","rb rt":"top","lt rt":"right"};var splittedOffset=o.offset.split(" ");var offset_left=parseInt(splittedOffset[0]);var offset_top=parseInt(splittedOffset[1]);var getViewport=function(){var viewport;var width;var height;var left;var top;if(typeof window.innerWidth!="undefined"){viewport=window;width=viewport.innerWidth;height=viewport.innerHeight;left=0+offset_left+viewport.pageXOffset;top=0+offset_top+viewport.pageYOffset;bottom=height+viewport.pageYOffset;right=width+viewport.pageXOffset;}else if(typeof document.documentElement!="undefined"&&typeof document.documentElement.clientWidth!='undefined'&&document.documentElement.clientWidth!=0){viewport=document.documentElement;width=viewport.clientWidth;height=viewport.clientHeight;left=0+offset_left+viewport.scrollLeft;top=0+offset_top+viewport.scrollTop;bottom=height+viewport.scrollTop;right=width+viewport.scrollLeft;}
return{element:viewport,left:left,top:top,bottom:bottom,right:right,width:width,height:height}};var getPosition=function(unitPoints){var xReferences={ll:context.left,lr:context.left+context.width,rr:context.left+context.width-element.outerWidth(),cc:context.left+context.width/2-element.outerWidth()/2}
var yReferences={tt:context.top,tb:context.top+context.height,bt:context.top-element.outerHeight(),mm:context.top+context.height/2-element.outerHeight()/2}
var axis={left:xReferences[unitPoints.my_x+unitPoints.at_x],top:yReferences[unitPoints.my_y+unitPoints.at_y]}
return axis;};var calculatePoints=function(points,unitPoints){var styles=getPosition(unitPoints);styles.direction=classReferences[points];var viewport=getViewport();if((points=="lt lb")&&((styles.top+element.outerHeight())>viewport.bottom)){unitPoints.my_y="b";unitPoints.at_y="t";styles=getPosition(unitPoints);styles.direction="top";styles.top-=context.height;};return styles;};var setPosition=function(points){var splitted=points.split(" ");var unitPoints={my_x:splitted[0].slice(0,1),my_y:splitted[0].slice(1,2),at_x:splitted[1].slice(0,1),at_y:splitted[1].slice(1,2)}
var styles=calculatePoints(points,unitPoints);element.css({left:styles.left,top:styles.top}).removeClass("top left down right").addClass(styles.direction);};var initPosition=function(){if(o.context){var contextOffset=o.context.offset();context={element:o.context,top:contextOffset.top+offset_top,left:contextOffset.left+offset_left,width:o.context.outerWidth(),height:o.context.outerHeight()};}else{context=getViewport();};setPosition(o.points);};initPosition();ui.utils.window.bind("resize scroll",initPosition);return $(element);};ui.object=function(){var that=this;return{prevent:function(event){if(event){event.preventDefault();event.stopPropagation();}},loadContent:function(conf){if(typeof conf.content!=='object'||!conf.content.type){alert('UI: "content" attribute error.');return;}else{switch(conf.content.type.toLowerCase()){case'ajax':var result=ui.get({method:"content",conf:conf});return result||'<p>Error on ajax call</p>';break;case'dom':return $(conf.content.data).html();break;case'param':return conf.content.data;break;};};},callbacks:function(conf,when){if(conf.callbacks&&conf.callbacks[when])conf.callbacks[when](conf);},publish:{}};}
ui.floats=function(){var that=ui.object();var clearTimers=function(){clearTimeout(st);clearTimeout(ht);};var createClose=function(conf){$('<p class="btn close">x</p>').bind('click',function(event){that.hide(event,conf);}).prependTo(conf.$htmlContent);};var createCone=function(conf){$('<div class="cone'+((conf.align)?' '+conf.align:'')+'"></div>').prependTo(conf.$htmlContent);};that.show=function(event,conf){that.prevent(event);if(conf.visible)return
conf.$htmlContent=$('<div class="ui-'+conf.name+'">');conf.$htmlContent.html(that.loadContent(conf)).hide().css('z-index',ui.utils.zIndex++).appendTo('body');if(conf.closeButton)createClose(conf);if(conf.cone)createCone(conf);if(conf.classes)conf.$htmlContent.addClass(conf.classes);conf.position.element=conf.$htmlContent;ui.positioner(conf.position);conf.visible=true;conf.$htmlContent.fadeIn('fast',function(){that.callbacks(conf,'show');});};that.hide=function(event,conf){that.prevent(event);if(!conf.visible)return;conf.$htmlContent.fadeOut('fast',function(event){$(this).remove();});conf.visible=false;that.callbacks(conf,'hide');};return that;}
ui.navs=function(){var that=ui.object();that.status=false;that.show=function(event,conf){that.prevent(event);that.status=true;conf.$trigger.addClass('on');conf.$htmlContent.show();that.callbacks(conf,'show');};that.hide=function(event,conf){that.prevent(event);that.status=false;conf.$trigger.removeClass('on');conf.$htmlContent.hide();that.callbacks(conf,'hide');};return that;}
ui.modal=function(conf){var that=ui.floats();conf.$trigger=$(conf.element);conf.closeButton=true;conf.classes='box';conf.ajaxType='POST';conf.position={fixed:true};conf.publish=that.publish;var show=function(event){if(conf.content.type.toLowerCase()==='ajax'){conf.content.data=conf.$trigger.attr('href')||conf.$trigger.parents('form').attr('action');conf.ajaxParams='x=x';if(conf.$trigger.attr('type')=='submit')setAjaxConfig();};dimmer.on();that.show(event,conf);$('.ui-modal .btn.close, .closeModal').bind('click',hide);conf.$trigger.blur();return conf.publish;};var hide=function(event){dimmer.off();that.hide(event,conf);return conf.publish;};var position=function(event){ui.positioner(conf.position);return conf.publish;}
var setAjaxConfig=function(){if(conf.content.data=='')alert('UI: Modal ajax configuration error.');conf.ajaxType=conf.$trigger.parents('form').attr('method')||'POST';var serialized=conf.$trigger.parents('form').serialize();conf.ajaxParams=conf.ajaxParams+((serialized!='')?'&'+serialized:'');};var dimmer={on:function(){$('<div>').bind('click',hide).addClass('ui-dimmer').css({height:$(window).height(),display:'block',zIndex:ui.utils.zIndex++}).hide().appendTo('body').fadeIn();},off:function(){$('div.ui-dimmer').fadeOut('normal',function(){$(this).remove();});}};conf.$trigger.css('cursor','pointer').bind('click',show);conf.publish.uid=conf.id,conf.publish.element=conf.element,conf.publish.type="ui.modal",conf.publish.content=conf.content.data,conf.publish.show=function(event){return show(event)},conf.publish.hide=function(event){return hide(event)},conf.publish.position=function(event){return position(event)}
return conf.publish;};
ui.init();
})(jQuery);